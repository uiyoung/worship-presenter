<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        font-family: 'Noto Sans KR', sans-serif;
      }
    </style>
    <title>new song</title>
  </head>
  <body>
    <form action="/song" method="post" id="song-form">
      <div>
        <input type="radio" name="song-type" id="hymn" value="HYMN" required />
        <label for="hymn">찬송가</label>
        <input type="radio" name="song-type" id="ccm" value="CCM" required />
        <label for="ccm">CCM</label>
      </div>
      <div><input type="text" name="title" id="title" placeholder="제목" required /></div>
      <div>
        <textarea name="lyrics" id="lyrics" cols="40" rows="20" placeholder="가사"></textarea>
      </div>
      <div>
        <select name="lines-per-slide" id="lines-per-slide">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
        <button type="button" id="auto-align">줄씩 정렬</button>
        <div>
          <input type="checkbox" name="include-title" id="include-title" />
          <label for="include-title">슬라이드에 제목 포함</label>
        </div>
        <a href="https://hangeul.naver.com/font/nanum">나눔폰트 다운로드</a>
        <button type="button" id="test">test lyrics</button>
        <button type="button" id="generate-ppt">PPT 바로 생성</button>
      </div>
      <div><input type="text" name="memo" id="memo" placeholder="메모" /></div>
      <div>
        <button type="submit" id="uploadBtn">저장</button>
      </div>
    </form>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
  <script>
    const lyricsTextArea = document.querySelector('#lyrics');
    const songTitle = document.querySelector('#title');

    const testBtn = document.querySelector('#test');
    testBtn.addEventListener('click', () => {
      const testTitle = '하위이이잉';
      const testLyrics =
        '우리 주는 위대하며 능력이 많으시도다\n그의 지혜 무궁하며 인자는 영원하도다\n\n상한자들 고치시며 상처를 싸매시도다\n별들의 수를 세시며 이름을 붙이셨도다\n\n그가 구름으로 하늘을 덮으시며 \n땅을 위하여 비 준비하시니\n\n예루살렘아 여호와를 \n찬송할지어다 네 하나님을 \n\n감사함으로 그 앞에 나가며 \n주 임재함을 경배해\n';
      songTitle.value = testTitle;
      lyricsTextArea.value = testLyrics;
    });

    // 가사 자동정렬
    const autoAlignBtn = document.querySelector('#auto-align');
    autoAlignBtn.addEventListener('click', () => {
      const lines = lyricsTextArea.value
        .split('\n')
        .filter((e) => e != '')
        .map((e) => e.trim().replace(/\s+/g, ' '));

      if (lines.length <= 0) {
        alert('가사를 입력해주세요.');
        lyricsTextArea.focus();
        return;
      }

      const LINES_PER_SLIDE = 2;
      let result = [];
      const temp = [...lines];
      const cnt = Math.ceil(temp.length / LINES_PER_SLIDE);
      for (let i = 0; i < cnt; i++) {
        result.push(temp.splice(0, LINES_PER_SLIDE));
      }
      result = result.map((e) => e.join('\n')).join('\n\n');

      lyricsTextArea.value = result;
    });

    // PPT 생성
    const generateBtn = document.querySelector('#generate-ppt');
    generateBtn.addEventListener('click', (e) => {
      e.preventDefault();

      if (lyricsTextArea.value.trim().length <= 0) {
        alert('가사를 입력해주세요.');
        lyricsTextArea.focus();
        return;
      }

      const lyricsPerSlideArr = lyricsTextArea.value.trim().split('\n\n');
      console.log(lyricsPerSlideArr);

      // align(left, center, right, justify)
      const align = 'center';

      // vertical align(top, middle, bottom)
      const valign = 'bottom';

      // 1. Create a new Presentation
      const pptx = new PptxGenJS();

      // font style
      // const fontFace = '나눔스퀘어라운드 Bold';
      const fontFace = '나눔고딕 Bold';
      const fontSize = 36;
      const fontBold = false;
      const fontItalic = false;
      const fontUnderline = false;
      const fontColor = 'FFFFFF';
      const fontOutline = { size: 0.5, color: '000000' };
      const fontGlow = { size: 2, opacity: 1.0, color: '#000000' };

      const CM_1 = 28.346; // 1cm = 28.346pt

      // sections by song
      pptx.addSection({ title: songTitle.value });

      // title slide master
      pptx.defineSlideMaster({
        title: 'TITLE_SLIDE',
        background: { color: '009933' },
        objects: [
          {
            placeholder: {
              options: {
                name: 'song-title',
                type: 'title',
                w: '100%',
                h: '20%',
                autoFit: true,
                align: 'left',
                valign: 'top',
                fontSize: 24,
                fontFace,
                color: fontColor,
                outline: fontOutline,
                glow: fontGlow,
                margin: [CM_1, CM_1, CM_1, CM_1],
              },
              text: '(title here!)',
            },
          },
        ],
      });

      // lyrics slide master
      pptx.defineSlideMaster({
        title: 'LYRICS_SLIDE',
        background: { color: '009933' },
        objects: [
          {
            placeholder: {
              options: {
                name: 'lyrics-body',
                type: 'body',
                w: '100%',
                h: '100%',
                autoFit: true,
                align,
                valign,
                bold: fontBold,
                italic: fontItalic,
                underline: fontUnderline,
                fontSize,
                fontFace,
                color: fontColor,
                outline: fontOutline,
                glow: fontGlow,
                lineSpacing: fontSize * 1.025,
                margin: [1, 1, CM_1, CM_1],
              },
              text: '(lyrics here!)',
            },
          },
        ],
      });

      // add title slide
      const slide = pptx.addSlide({ masterName: 'TITLE_SLIDE', sectionTitle: songTitle.value });
      slide.addText(songTitle.value, { placeholder: 'song-title' });

      // Add Lyrics Slide
      lyricsPerSlideArr.forEach((lyrics) => {
        const slide = pptx.addSlide({ masterName: 'LYRICS_SLIDE', sectionTitle: songTitle.value });

        // Add one or more objects (Tables, Shapes, Images, Text and Media) to the Slide
        slide.addText(lyrics, { placeholder: 'lyrics-body' });
      });

      // 4. Save the Presentation
      pptx.writeFile({ fileName: `${songTitle.value}.pptx` });
    });

    //   const songType = document.querySelector('input[name=song-type]:checked')?.value;
    //   console.log(songType);
  </script>
</html>
